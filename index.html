<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>ASTARK — Full Auto Digit Predictor + Trader</title>
<style>
  :root{
    --bg:#071226; --panel:#0f2433; --muted:#9aa7b1; --accent:#00bfff; --text:#e6eef8;
    --good:#2ee6a8; --bad:#ff6b6b; --highlight:#123f2e;
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:Inter,Arial,Helvetica,sans-serif;background:var(--bg);color:var(--text)}
  header{padding:14px 18px;background:linear-gradient(90deg,#071b2e,#0a2b48);display:flex;justify-content:space-between;align-items:center}
  header .title{font-weight:800;color:var(--accent);font-size:18px}
  .wrap{max-width:1200px;margin:18px auto;padding:12px;display:grid;grid-template-columns:320px 1fr 360px;gap:14px}
  .card{background:var(--panel);padding:14px;border-radius:10px;box-shadow:0 8px 24px rgba(0,0,0,0.45)}
  label{display:block;color:var(--muted);font-weight:700;margin-bottom:6px;font-size:13px}
  input,select{width:100%;padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:#071019;color:var(--text)}
  .row{display:flex;gap:8px;align-items:center}
  .btn{padding:10px 12px;border-radius:8px;border:none;cursor:pointer;font-weight:700}
  .primary{background:linear-gradient(90deg,var(--accent),#0077ff);color:#071123}
  .danger{background:var(--bad);color:#071123}
  .small{font-size:13px;color:var(--muted)}
  /* center */
  .center{display:flex;flex-direction:column;gap:12px}
  .markers{display:flex;gap:18px;align-items:center;justify-content:center}
  .big-circle{width:120px;height:120px;border-radius:999px;display:flex;align-items:center;justify-content:center;font-weight:900;font-size:44px}
  .blue{background:var(--accent);color:#071123}
  .amber{background:#f59e0b;color:#071123}
  /* digits row */
  #digitsRow{display:flex;gap:8px;justify-content:center;align-items:center;padding:10px}
  .digitCell{width:44px;height:44px;border-radius:8px;background:#0b2430;display:flex;align-items:center;justify-content:center;font-weight:800}
  .digitTop{background:#072f3d;color:var(--text)}
  .digitBest{background:#2a6b3b;color:#eaffef;font-weight:900;box-shadow:0 8px 20px rgba(46,230,168,0.06)}
  #cursor{position:fixed;width:18px;height:18px;border-radius:50%;background:#38bdf8;pointer-events:none;box-shadow:0 0 18px rgba(56,189,248,0.85);transform:translate(-50%,-50%);transition:transform .12s linear;z-index:9999}
  table{width:100%;border-collapse:collapse;color:var(--text);font-size:13px}
  th,td{padding:8px;border-bottom:1px solid rgba(255,255,255,0.03);text-align:center}
  th{background:#072032}
  .logs{max-height:240px;overflow:auto;font-family:monospace;font-size:13px;background:#071623;padding:8px;border-radius:6px}
  .trade-win{color:var(--good)}
  .trade-loss{color:var(--bad)}
  .highlight{background:var(--highlight)}
  @media (max-width:980px){.wrap{grid-template-columns:1fr;gap:10px}.cursor{display:none}}
</style>
</head>
<body>
<header>
  <div class="title">ASTARK — Auto Digit Predictor & Trader</div>
  <div class="small">Frontend demo • paste DERIV DEMO token below</div>
</header>

<div class="wrap">
  <!-- LEFT: Controls -->
  <div class="card">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <div style="font-weight:800">Controls</div>
      <div class="small">WS: <span id="wsState">disconnected</span></div>
    </div>

    <div style="margin-top:12px">
      <label>Deriv API Token</label>
      <input id="apiToken" placeholder="Paste DEMO token here" />
      <div style="display:flex;gap:8px;margin-top:8px">
        <button id="btnAuth" class="btn primary">Authorize</button>
        <button id="btnClearToken" class="btn" style="background:#1f2a38;color:#fff">Clear</button>
      </div>
    </div>

    <div style="margin-top:10px">
      <label>Market (synthetic volatility)</label>
      <select id="market">
        <option value="R_10">Volatility 10 (R_10)</option>
        <option value="R_25">Volatility 25 (R_25)</option>
        <option value="R_50">Volatility 50 (R_50)</option>
        <option value="R_75">Volatility 75 (R_75)</option>
        <option value="R_100" selected>Volatility 100 (R_100)</option>
        <option value="1HZ10V">Vol 10 (1s)</option>
        <option value="1HZ25V">Vol 25 (1s)</option>
        <option value="1HZ50V">Vol 50 (1s)</option>
        <option value="1HZ75V">Vol 75 (1s)</option>
        <option value="1HZ100V">Vol 100 (1s)</option>
        <option value="BOOM1000">Boom 1000 (example)</option>
        <option value="CRASH1000">Crash 1000 (example)</option>
      </select>
    </div>

    <div style="margin-top:10px">
      <label>Contract Type (auto)</label>
      <select id="contractType">
        <option value="DIGITMATCH">Digit Match</option>
        <option value="DIGITDIFF">Digit Differs</option>
        <option value="DIGITEVEN">Digit Even</option>
        <option value="DIGITODD">Digit Odd</option>
        <option value="DIGITOVER">Digit Over</option>
        <option value="DIGITUNDER">Digit Under</option>
        <option value="CALL">Rise (CALL)</option>
        <option value="PUT">Fall (PUT)</option>
      </select>
    </div>

    <div style="margin-top:10px">
      <label>Stake (USD)</label>
      <input id="stake" type="number" min="0.35" step="0.01" value="1"/>
    </div>

    <div style="margin-top:10px">
      <label>Duration (ticks)</label>
      <input id="duration" type="number" min="1" value="1"/>
    </div>

    <div style="margin-top:10px">
      <label>Prediction window (ticks) — rolling N</label>
      <input id="windowSize" type="number" min="10" max="1000" value="100"/>
      <div class="small">Smaller = faster/reactive. Larger = smoother.</div>
    </div>

    <div style="margin-top:10px">
      <label>Throttle (ms) — min delay between buys</label>
      <input id="throttle" type="number" min="0" value="0"/>
      <div class="small">Set >0 if you see rate-limit errors.</div>
    </div>

    <div style="margin-top:12px;display:flex;gap:8px">
      <button id="startBtn" class="btn primary">▶ Start Bot</button>
      <button id="stopBtn" class="btn danger">⏹ Stop</button>
    </div>

    <div style="margin-top:12px" class="small">Mode: Full Auto — predictor drives barrier automatically.</div>
  </div>

  <!-- CENTER: Predictor visualization + frequency -->
  <div class="card center">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <div style="font-weight:800">Real-time Digit Predictor</div>
      <div class="small">Market: <span id="liveMarket">—</span></div>
    </div>

    <div id="digitsRow" style="margin-top:12px">
      <!-- digits inserted by JS -->
    </div>

    <div style="display:flex;gap:12px;justify-content:center;align-items:center;margin-top:6px">
      <div class="small">Ticks observed: <b id="tickCount">0</b></div>
      <div class="small">Top digit: <b id="topDigit">—</b></div>
      <div class="small">Top %: <b id="topPct">—</b></div>
    </div>

    <div style="margin-top:10px">
      <table>
        <thead><tr><th>Digit</th><th>Count</th><th>Percent</th></tr></thead>
        <tbody id="freqBody"></tbody>
      </table>
    </div>
  </div>

  <!-- RIGHT: Trades & logs -->
  <div class="card">
    <div style="font-weight:800;display:flex;justify-content:space-between;align-items:center">
      <div>Status</div>
      <div class="small">Authorized: <span id="authState">no</span></div>
    </div>

    <div style="margin-top:10px">
      <div style="font-weight:700">Open Trades</div>
      <table><thead><tr><th>ID</th><th>Type</th><th>Barrier</th><th>Stake</th></tr></thead>
      <tbody id="openBody"></tbody></table>
    </div>

    <div style="margin-top:10px">
      <div style="font-weight:700">Closed Trades</div>
      <table><thead><tr><th>ID</th><th>Type</th><th>Result</th><th>Payout</th></tr></thead>
      <tbody id="closedBody"></tbody></table>
    </div>

    <div style="margin-top:12px;font-weight:700">Logs</div>
    <div class="logs" id="logs"></div>
    <div style="display:flex;gap:8px;margin-top:8px">
      <button id="clearLogs" class="btn">Clear</button>
      <button id="downloadLog" class="btn">Download</button>
    </div>
  </div>
</div>

<div id="cursor"></div>

<script>
/* ========== State ========== */
let ws = null;
let authorized = false;
let subscribedMarket = null;
let tickHistory = []; // rolling last-N digits
let digitCounts = Array.from({length:10},()=>0);
let tickCount = 0;
let botRunning = false;
let lastBuyTs = 0;
let openTrades = {}; // contract_id -> info
let closedTrades = [];
let settings = { throttle:0 };

/* ========== DOM refs ========== */
const apiTokenEl = document.getElementById('apiToken');
const btnAuth = document.getElementById('btnAuth');
const btnClearToken = document.getElementById('btnClearToken');
const wsState = document.getElementById('wsState');
const authState = document.getElementById('authState');
const marketEl = document.getElementById('market');
const startBtn = document.getElementById('startBtn');
const stopBtn = document.getElementById('stopBtn');
const contractTypeEl = document.getElementById('contractType');
const stakeEl = document.getElementById('stake');
const durationEl = document.getElementById('duration');
const windowSizeEl = document.getElementById('windowSize');
const throttleEl = document.getElementById('throttle');

const digitsRow = document.getElementById('digitsRow');
const freqBody = document.getElementById('freqBody');
const tickCountEl = document.getElementById('tickCount');
const topDigitEl = document.getElementById('topDigit');
const topPctEl = document.getElementById('topPct');

const logsEl = document.getElementById('logs');
const openBody = document.getElementById('openBody');
const closedBody = document.getElementById('closedBody');
const cursorDot = document.getElementById('cursor');

/* ========== UI init: digits row ========= */
for(let d=0; d<10; d++){
  const div=document.createElement('div');
  div.className='digitCell';
  div.dataset.d=d;
  div.innerText=d;
  digitsRow.appendChild(div);
}

/* ========== Utilities ========= */
function uiLog(msg){
  const t=new Date().toLocaleTimeString();
  logsEl.innerHTML = `<div>[${t}] ${escapeHtml(msg)}</div>` + logsEl.innerHTML;
}
function escapeHtml(s){return String(s).replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));}
function setWsState(s){ wsState.innerText = s; }
function setAuthState(v){ authState.innerText = v ? 'yes' : 'no'; }

/* ========== WebSocket & Deriv API helpers ========= */
function connectWebsocket(){
  const appId = '1089'; // public demo app id
  if(ws){ try{ ws.close(); }catch(e){} }
  ws = new WebSocket(`wss://ws.binaryws.com/websockets/v3?app_id=${appId}`);
  setWsState('connecting');
  ws.onopen = ()=> { setWsState('connected'); uiLog('WS open'); authorizeIfToken(); };
  ws.onclose = ()=> { setWsState('closed'); setAuthState(false); uiLog('WS closed'); };
  ws.onerror = (e)=> { uiLog('WS error: '+ (e?.message||JSON.stringify(e))); };
  ws.onmessage = wsMessageHandler;
}

function authorizeIfToken(){
  const token = apiTokenEl.value.trim();
  if(!token) return;
  try{ ws.send(JSON.stringify({ authorize: token })); uiLog('Sending authorize...'); }catch(e){ uiLog('Authorize send failed'); }
}

/* central handler */
function wsMessageHandler(evt){
  let data;
  try{ data = JSON.parse(evt.data); }catch(e){ uiLog('WS parse error'); return; }

  if(data.msg_type === 'authorize'){
    if(data.authorize && data.authorize.loginid){
      authorized = true;
      setAuthState(true);
      uiLog('Authorized as ' + data.authorize.loginid);
    } else {
      authorized = false;
      setAuthState(false);
      uiLog('Authorization failed');
    }
  }

  if(data.msg_type === 'tick' && data.tick){
    handleTick(data.tick);
  }

  if(data.msg_type === 'buy' && data.buy){
    // buy response returned
    const b = data.buy;
    const cid = b.contract_id || b.transaction_id || ('cid_'+Date.now());
    openTrades[cid] = {
      contract_id: cid,
      contract_type: b.contract_type || b.longcode || 'DIGIT',
      barrier: b.barrier ?? b.parameters?.barrier ?? null,
      stake: b.buy_price ?? b.purchase_price ?? b.price ?? b.buy_price ?? 0
    };
    addOpenTradeRow(openTrades[cid]);
    uiLog('Buy accepted, cid=' + cid);
    // subscribe for contract updates
    try{ ws.send(JSON.stringify({ proposal_open_contract:1, contract_id: cid })); }catch(e){}
  }

  if(data.msg_type === 'proposal_open_contract' && data.proposal_open_contract){
    const poc = data.proposal_open_contract;
    // when it's sold, add to closed
    if(poc.is_sold){
      const cid = poc.contract_id;
      const payout = typeof poc.profit !== 'undefined' ? poc.profit : (poc.payout ?? 0);
      moveToClosed({ contract_id: cid, contract_type: poc.contract_type, barrier: poc.barrier ?? null }, { status: poc.status, payout });
      uiLog(`Contract closed cid=${cid} profit=${payout}`);
    }
  }

  if(data.error){
    uiLog('API error: ' + JSON.stringify(data.error));
  }
}

/* ========== Tick & Predictor Logic ========== */
function handleTick(tick){
  const quote = String(tick.quote);
  const lastDigit = Number(quote.slice(-1));

  // update history window
  const windowSize = Math.max(10, Number(windowSizeEl.value) || 100);
  tickHistory.push(lastDigit);
  digitCounts[lastDigit] = (digitCounts[lastDigit]||0) + 1;
  if(tickHistory.length > windowSize){
    const removed = tickHistory.shift();
    digitCounts[removed] = Math.max(0, (digitCounts[removed]||0) - 1);
  }
  tickCount = tickHistory.length;

  // compute frequencies and best digit
  let bestDigit = 0; let bestCount = -1;
  const freq = [];
  for(let d=0; d<10; d++){
    const c = digitCounts[d] || 0;
    freq.push(c);
    if(c > bestCount){ bestCount = c; bestDigit = d; }
  }

  // update UI frequency table + highlight top
  updateFreqUI(freq, bestDigit);

  // move cursor to best digit
  moveCursorToDigit(bestDigit);

  // if bot running -> attempt buy using bestDigit as barrier for digit contracts
  if(botRunning){
    attemptAutoBuy(bestDigit, lastDigit);
  }
}

/* update freq UI */
function updateFreqUI(freq, bestDigit){
  const tbody = freqBody;
  tbody.innerHTML = '';
  for(let d=0; d<10; d++){
    const count = freq[d] || 0;
    const pct = tickCount ? ((count / tickCount) * 100).toFixed(1) : '0.0';
    const tr = document.createElement('tr');
    if(d === bestDigit) tr.className = 'highlight';
    tr.innerHTML = `<td>${d}</td><td>${count}</td><td>${pct}%</td>`;
    tbody.appendChild(tr);
  }
  tickCountEl.innerText = tickCount;
  topDigitEl.innerText = bestDigit;
  const topPct = tickCount ? (( (digitCounts[bestDigit]||0) / tickCount) * 100).toFixed(1) : '0.0';
  topPctEl.innerText = topPct + '%';

  // also style digit in digitsRow
  document.querySelectorAll('.digitCell').forEach(el=>{
    el.classList.remove('digitTop','digitBest');
    const d = Number(el.dataset.d);
    el.classList.add('digitCell');
    if(d === bestDigit) el.classList.add('digitBest');
  });
}

/* cursor positioning */
function moveCursorToDigit(digit){
  try{
    const target = document.querySelector(`.digitCell[data-d="${digit}"]`);
    if(!target) return;
    const parentRect = digitsRow.getBoundingClientRect();
    const rect = target.getBoundingClientRect();
    const cx = rect.left + rect.width/2;
    const cy = rect.top + rect.height/2;
    cursorDot.style.transform = `translate(${cx}px, ${cy}px)`;
  }catch(e){}
}

/* ========== Auto-buy logic ========== */
function attemptAutoBuy(predictedDigit, lastTickDigit){
  const now = Date.now();
  const throttle = Math.max(0, Number(throttleEl.value) || 0);
  if(now - lastBuyTs < throttle) {
    // throttle in effect
    return;
  }

  // form contract parameters based on contract type
  const contractType = contractTypeEl.value;
  const stake = parseFloat(stakeEl.value) || 1;
  const duration = Math.max(1, parseInt(durationEl.value) || 1);
  const symbol = marketEl.value;

  // Determine parameters
  const params = {
    contract_type: contractType,
    symbol,
    amount: stake,
    basis: 'stake',
    duration,
    duration_unit: 't',
    currency: 'USD'
  };

  // For digit contracts: set barrier=predictedDigit
  if(['DIGITMATCH','DIGITDIFF','DIGITEVEN','DIGITODD','DIGITOVER','DIGITUNDER'].includes(contractType)){
    params.barrier = String(predictedDigit);
  }

  // For CALL/PUT: we can choose direction using predictedDigit vs lastTickDigit
  // Simple rule: if predictedDigit > lastTickDigit => CALL else PUT
  if(contractType === 'CALL' || contractType === 'PUT'){
    const direction = (predictedDigit > lastTickDigit) ? 'CALL' : 'PUT';
    params.contract_type = direction;
  }

  const buyReq = { buy: 1, subscribe: 1, price: stake, parameters: params };
  try{
    ws.send(JSON.stringify(buyReq));
    lastBuyTs = now;
    uiLog(`BUY sent — type=${params.contract_type} symbol=${symbol} stake=${stake} barrier=${params.barrier ?? '-'} dur=${duration}`);
  }catch(e){
    uiLog('Buy send failed: ' + e.message);
  }
}

/* ========== Open/Closed trade UI management ========= */
function addOpenTradeRow(tr){
  // ensure unique
  const tbody = openBody;
  const row = document.createElement('tr');
  row.id = 'open_' + tr.contract_id;
  row.innerHTML = `<td>${tr.contract_id}</td><td>${escapeHtml(tr.contract_type)}</td><td>${escapeHtml(tr.barrier ?? '')}</td><td>${escapeHtml(tr.stake ?? '')}</td>`;
  tbody.prepend(row);
}
function moveToClosed(tr, result){
  // remove open
  const row = document.getElementById('open_' + tr.contract_id);
  if(row) row.remove();
  // add closed
  const tbody = closedBody;
  const trEl = document.createElement('tr');
  const payout = Number(result.payout || 0);
  const cls = payout >= 0 ? 'trade-win' : 'trade-loss';
  trEl.innerHTML = `<td>${tr.contract_id}</td><td>${escapeHtml(tr.contract_type)}</td><td class="${cls}">${escapeHtml(result.status || '')}</td><td class="${cls}">${payout}</td>`;
  tbody.prepend(trEl);
}

/* ========== UI buttons & handlers ========= */
btnAuth.addEventListener('click', ()=>{
  const token = apiTokenEl.value.trim();
  if(!token){ alert('Paste your Deriv DEMO token first'); return; }
  if(!ws || ws.readyState !== 1) connectWebsocket();
  // authorize will be sent after open or now:
  try{ ws.send(JSON.stringify({ authorize: token })); uiLog('Authorize requested'); }catch(e){ uiLog('Auth send error'); }
});

btnClearToken.addEventListener('click', ()=>{ apiTokenEl.value=''; uiLog('Token cleared'); });

startBtn.addEventListener('click', ()=>{
  if(!ws || ws.readyState !== 1) connectWebsocket();
  const token = apiTokenEl.value.trim();
  if(!token){ alert('Please paste Deriv API token and press Authorize'); return; }
  // authorize explicitly if not authorized
  try{ ws.send(JSON.stringify({ authorize: token })); }catch(e){}
  // subscribe ticks
  subscribedMarket = marketEl.value;
  try{ ws.send(JSON.stringify({ ticks: subscribedMarket, subscribe: 1 })); uiLog('Subscribed to ticks: ' + subscribedMarket); }catch(e){ uiLog('Subscribe error'); }
  botRunning = true;
  uiLog('Bot started - FULL AUTO mode');
});

stopBtn.addEventListener('click', ()=>{
  botRunning = false;
  uiLog('Bot stopped by user');
  // keep WS open for monitoring but unsubscribe ticks by sending empty? to be simple, close ws
  try{ ws.close(); }catch(e){}
});

/* log clear & download */
document.getElementById('clearLogs').addEventListener('click', ()=> logsEl.innerHTML='');
document.getElementById('downloadLog').addEventListener('click', ()=>{
  const text = logsEl.innerText;
  const blob = new Blob([text], {type:'text/plain'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = 'astark-log.txt'; a.click(); URL.revokeObjectURL(url);
});

/* ========== Init ========== */
uiLog('UI ready — paste Demo token, Authorize, choose market, then S
