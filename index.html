<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ASTARK SpeedBot (Real)</title>
  <style>
    body { font-family: Arial, sans-serif; background: #121212; color: #fff; text-align: center; }
    h1 { color: #4CAF50; }
    select, button, input { padding: 10px; margin: 10px; font-size: 16px; }
    #digit-board { display: flex; justify-content: center; margin-top: 20px; }
    .digit { width: 30px; height: 30px; margin: 5px; border: 1px solid #555; display: flex; align-items: center; justify-content: center; }
    #prediction-marker { position: relative; top: -10px; color: yellow; font-weight: bold; }
    #open-trades, #closed-trades { margin-top: 20px; text-align: left; max-width: 400px; margin-left: auto; margin-right: auto; }
  </style>
</head>
<body>
  <h1>‚ö° ASTARK SpeedBot (Real)</h1>

  <label>API Token:</label>
  <input type="password" id="apiToken" placeholder="Enter Deriv API token" style="width:300px;">
  <br>

  <label>Choose Market:</label>
  <select id="market">
    <option value="R_10">Volatility 10</option>
    <option value="R_25">Volatility 25</option>
    <option value="R_50">Volatility 50</option>
    <option value="R_75">Volatility 75</option>
    <option value="R_100">Volatility 100</option>
  </select>

  <br>
  <button id="start">‚ñ∂Ô∏è Start Bot</button>
  <button id="stop">‚èπÔ∏è Stop Bot</button>

  <div id="digit-board"></div>
  <div id="prediction-marker">‚¨Ü</div>

  <h2>üìÇ Open Trades</h2>
  <div id="open-trades"></div>

  <h2>‚úÖ Closed Trades</h2>
  <div id="closed-trades"></div>

  <script>
    let ws;
    let running = false;
    let digitStats = Array(10).fill(0);
    let tickHistory = [];
    const MAX_HISTORY = 100;

    const openTrades = [];
    const closedTrades = [];
    const contracts = {}; // Track contract IDs

    const digitBoard = document.getElementById("digit-board");
    for (let i = 0; i < 10; i++) {
      const div = document.createElement("div");
      div.className = "digit";
      div.innerText = i;
      digitBoard.appendChild(div);
    }

    document.getElementById("start").onclick = () => {
      if (running) return;
      running = true;

      const market = document.getElementById("market").value;
      const token = document.getElementById("apiToken").value;
      if (!token) {
        alert("Enter your Deriv API token first!");
        running = false;
        return;
      }

      ws = new WebSocket("wss://ws.binaryws.com/websockets/v3?app_id=1089");

      ws.onopen = () => {
        ws.send(JSON.stringify({ authorize: token }));
      };

      ws.onmessage = (msg) => {
        const data = JSON.parse(msg.data);

        if (data.msg_type === "authorize") {
          ws.send(JSON.stringify({ ticks: market, subscribe: 1 }));
        }

        if (data.msg_type === "tick") {
          handleTick(data.tick);
        }

        if (data.msg_type === "buy") {
          const contract_id = data.buy.contract_id;
          contracts[contract_id] = { id: contract_id, digit: data.buy.starting_spot, entry: data.buy.buy_price };
          openTrades.push({ contract_id, digit: contracts[contract_id].digit, entry: contracts[contract_id].entry, time: new Date().toLocaleTimeString() });
          renderTrades();

          ws.send(JSON.stringify({ proposal_open_contract: 1, contract_id, subscribe: 1 }));
        }

        if (data.msg_type === "proposal_open_contract") {
          const poc = data.proposal_open_contract;
          if (poc.is_sold) {
            closedTrades.push({ digit: poc.entry_spot, entry: poc.buy_price, result: poc.profit >= 0 ? "WIN ‚úÖ" : "LOSE ‚ùå", time: new Date().toLocaleTimeString() });
            openTrades.splice(openTrades.findIndex(t => t.contract_id === poc.contract_id), 1);
            renderTrades();
          }
        }
      };
    };

    document.getElementById("stop").onclick = () => {
      running = false;
      if (ws) ws.close();
    };

    function handleTick(tick) {
      const price = tick.quote;
      const lastDigit = parseInt(price.toString().slice(-1));

      tickHistory.push(lastDigit);
      if (tickHistory.length > MAX_HISTORY) {
        const removed = tickHistory.shift();
        digitStats[removed]--;
      }
      digitStats[lastDigit]++;

      const bestDigit = updatePredictionMarker();

      if (running) {
        placeTrade(bestDigit);
      }
    }

    function updatePredictionMarker() {
      let bestDigit = 0;
      let maxCount = -1;

      for (let d = 0; d < 10; d++) {
        if (digitStats[d] > maxCount) {
          maxCount = digitStats[d];
          bestDigit = d;
        }
      }

      const marker = document.getElementById("prediction-marker");
      marker.style.left = `${bestDigit * 35}px`;
      marker.innerText = "‚¨Ü " + bestDigit;

      return bestDigit;
    }

    function placeTrade(predictedDigit) {
      const market = document.getElementById("market").value;

      const proposal = {
        buy: 1,
        subscribe: 1,
        price: 10, // stake = $10
        parameters: {
          contract_type: "DIGITMATCH",
          symbol: market,
          amount: 10,
          basis: "stake",
          currency: "USD",
          duration: 1,
          duration_unit: "t",
          barrier: predictedDigit
        }
      };

      ws.send(JSON.stringify(proposal));
    }

    function renderTrades() {
      const openDiv = document.getElementById("open-trades");
      openDiv.innerHTML = openTrades.map(t => `<p>ID: ${t.contract_id} | Entry: ${t.entry} | Time: ${t.time}</p>`).join("");

      const closedDiv = document.getElementById("closed-trades");
      closedDiv.innerHTML = closedTrades.map(t => `<p>Digit: ${t.digit} | Entry: ${t.entry} | ${t.result} | Time: ${t.time}</p>`).join("");
    }
  </script>
</body>
</html>
