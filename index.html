<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ASTARK — SpeedBot (Frontend-only)</title>
<style>
  :root{
    --bg:#071226; --panel:#0f2433; --muted:#9aa7b1; --accent:#00bfff; --text:#e6eef8;
    --success:#2ee6a8; --warn:#f59e0b; --danger:#ff6b6b;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font-family:Inter,Arial,Helvetica,sans-serif}
  header{background:linear-gradient(90deg,#071b2e,#0a2b48);padding:14px 18px;display:flex;justify-content:space-between;align-items:center}
  .brand{font-weight:800;color:var(--accent);font-size:18px}
  .container{padding:16px;max-width:1100px;margin:20px auto;display:grid;grid-template-columns:320px 1fr 340px;gap:14px}
  .card{background:var(--panel);padding:14px;border-radius:10px;box-shadow:0 6px 20px rgba(0,0,0,0.25)}
  label{display:block;color:var(--muted);font-weight:700;margin-bottom:6px}
  input,select{width:100%;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.03);background:#071019;color:var(--text)}
  .row{display:flex;gap:8px;align-items:center}
  .btn{padding:10px 12px;border-radius:8px;border:none;cursor:pointer;font-weight:700}
  .primary{background:linear-gradient(90deg,var(--accent),#0077ff);color:#071123}
  .danger{background:var(--danger);color:#071123}
  .muted{color:var(--muted);font-size:13px}
  .center-panel{display:flex;flex-direction:column;gap:12px}
  .markers{display:flex;gap:18px;align-items:center;justify-content:center}
  .big-circle{width:120px;height:120px;border-radius:999px;display:flex;align-items:center;justify-content:center;font-weight:900;font-size:44px}
  .blue{background:var(--accent);color:#071123;box-shadow:0 12px 30px rgba(0,191,255,0.08)}
  .amber{background:var(--warn);color:#071123}
  .pink{background:var(--danger);color:#071123}
  .cursor{position:fixed;width:14px;height:14px;border-radius:50%;background:#38bdf8;pointer-events:none;box-shadow:0 0 18px rgba(56,189,248,0.85);transform:translate(-50%,-50%);transition:transform .15s linear}
  table{width:100%;border-collapse:collapse;margin-top:8px}
  th,td{padding:8px;border:1px solid rgba(255,255,255,0.03);text-align:center;font-family:monospace}
  th{background:#072032;color:var(--text)}
  .highlight{background:var(--accent);color:#071123;font-weight:800}
  .logs{max-height:260px;overflow:auto;font-family:monospace;font-size:13px}
  .small{font-size:13px;color:var(--muted)}
  footer{padding:10px 18px;text-align:center;color:var(--muted);font-size:13px}
  @media (max-width:980px){
    .container{grid-template-columns:1fr; padding:10px}
    .cursor{display:none}
  }
</style>
</head>
<body>
  <header>
    <div class="brand">ASTARK — Speed Trading (Frontend)</div>
    <div class="small">Frontend-only demo — use DEMO token</div>
  </header>

  <div class="container">
    <!-- Left: Controls -->
    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div style="font-weight:800">Controls</div>
        <div class="small">Status: <span id="status-ws">connecting...</span></div>
      </div>

      <div style="margin-top:12px">
        <label>Deriv App ID (1089 is public)</label>
        <input id="appId" value="1089" />
      </div>

      <div style="margin-top:10px">
        <label>Deriv API Token (DEMO recommended)</label>
        <input id="token" placeholder="Paste demo token here (keeps client-only)" />
      </div>

      <div style="margin-top:10px">
        <label>Market</label>
        <select id="market">
          <!-- Volatility continuous -->
          <option value="R_10">Volatility 10 (R_10)</option>
          <option value="R_25">Volatility 25 (R_25)</option>
          <option value="R_50">Volatility 50 (R_50)</option>
          <option value="R_75">Volatility 75 (R_75)</option>
          <option value="R_100" selected>Volatility 100 (R_100)</option>

          <!-- 1s variants (format used on Deriv sometimes varies) -->
          <option value="1HZ10V">Vol 10 (1s)</option>
          <option value="1HZ25V">Vol 25 (1s)</option>
          <option value="1HZ50V">Vol 50 (1s)</option>
          <option value="1HZ75V">Vol 75 (1s)</option>
          <option value="1HZ100V">Vol 100 (1s)</option>

          <!-- Boom/Crash samples -->
          <option value="BOOM1000">Boom 1000</option>
          <option value="BOOM500">Boom 500</option>
          <option value="CRASH1000">Crash 1000</option>
          <option value="CRASH500">Crash 500</option>
        </select>
      </div>

      <div style="margin-top:10px">
        <label>Stake (USD)</label>
        <input id="stake" type="number" min="0.1" step="0.1" value="1" />
      </div>

      <div style="margin-top:10px">
        <label>Duration (ticks)</label>
        <input id="duration" type="number" min="1" value="1" />
      </div>

      <div style="margin-top:10px">
        <label>Auto Trading Mode (what bot places)</label>
        <select id="autoMode">
          <option value="DIGITMATCH">Digit Match (use predicted digit)</option>
          <option value="CALLPUT">Call/Put (pred1 > last -> CALL)</option>
          <option value="DIGITEVENODD">Even/Odd (pred1 parity)</option>
        </select>
      </div>

      <div style="margin-top:10px">
        <label>Target Digit (leave blank = any)</label>
        <input id="targetDigit" type="number" min="0" max="9" placeholder="e.g. 7" />
      </div>

      <div style="margin-top:10px">
        <label>Throttle (ms) — 0 = fastest (risky)</label>
        <input id="throttle" type="number" min="0" value="0" />
      </div>

      <div style="display:flex;gap:8px;margin-top:12px">
        <button id="btnStart" class="btn primary">▶ Start Bot</button>
        <button id="btnStop" class="btn danger">⏹ Stop Bot</button>
      </div>

      <div style="margin-top:10px" class="small">Manual trade (debug / testing)</div>
      <div style="display:flex;flex-wrap:wrap;gap:8px;margin-top:8px">
        <button class="btn" onclick="manualTrade('DIGITMATCH')">Matches</button>
        <button class="btn" onclick="manualTrade('DIGITDIFF')">Differs</button>
        <button class="btn" onclick="manualTrade('DIGITEVEN')">Even</button>
        <button class="btn" onclick="manualTrade('DIGITODD')">Odd</button>
        <button class="btn" onclick="manualTrade('CALL')">Rise</button>
        <button class="btn" onclick="manualTrade('PUT')">Fall</button>
        <button class="btn" onclick="manualTrade('DIGITOVER')">Over</button>
        <button class="btn" onclick="manualTrade('DIGITUNDER')">Under</button>
      </div>

      <div style="margin-top:12px" class="small">
        <strong>Notes:</strong><br>
        - Use DEMO token for testing.<br>
        - Frontend-only = token visible in browser devtools.<br>
        - Rapid auto-buy may trigger rate limits; set throttle if needed.
      </div>
    </div>

    <!-- Center: live markers -->
    <div class="card center-panel">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div style="font-weight:800">Live Digit Predictors</div>
        <div class="small">Connected market: <span id="liveMarket">—</span></div>
      </div>

      <div class="markers" style="margin-top:14px">
        <div style="text-align:center">
          <div id="markerCurrent" class="big-circle blue">—</div>
          <div class="small">Current Digit</div>
        </div>

        <div style="text-align:center">
          <div id="markerPred1" class="big-circle amber">—</div>
          <div class="small">Predicted Next (pred1)</div>
        </div>

        <div style="text-align:center">
          <div id="markerPred2" class="big-circle pink" style="width:80px;height:80px;font-size:28px">—</div>
          <div class="small">Meta Prediction (pred2)</div>
        </div>
      </div>

      <div style="margin-top:12px;text-align:center">
        <div id="statsSummary" class="small">Ticks: <span id="tickCount">0</span> • Bot: <span id="botState">stopped</span></div>
      </div>

      <div style="margin-top:12px">
        <table>
          <thead><tr><th>Digit</th><th>Count</th><th>Percentage</th></tr></thead>
          <tbody id="digitTable"></tbody>
        </table>
      </div>
    </div>

    <!-- Right: logs & status -->
    <div class="card">
      <div style="font-weight:800">Status</div>
      <div style="margin-top:8px" class="small">WebSocket: <span id="wsState">connecting...</span></div>
      <div style="margin-top:6px" class="small">Authorization: <span id="authState">no</span></div>

      <div style="margin-top:12px;font-weight:800">Quick Logs</div>
      <div style="margin-top:8px" class="logs" id="logBox"></div>
      <div style="margin-top:12px">
        <button class="btn" onclick="clearLogs()">Clear</button>
        <button class="btn" onclick="snapshot()">Snapshot</button>
      </div>
    </div>
  </div>

  <div class="cursor" id="cursorDot" style="display:none"></div>

  <footer>
    ASTARK SpeedBot — frontend only demo. Use Demo token. For production move token to backend.
  </footer>

<script>
/* ---------- State ---------- */
let ws = null;
let connectedWS = false;
let authorized = false;
let subscribedMarket = null;

let tickCount = 0;
let digitCounts = Array.from({length:10},()=>0);
let lastDigit = null;
let pred1 = null;
let pred2 = null;

let botRunning = false;
let botLastBuyTs = 0;

/* ---------- DOM refs ---------- */
const statusWsEl = document.getElementById('status-ws');
const wsStateEl = document.getElementById('wsState');
const authStateEl = document.getElementById('authState');
const liveMarketEl = document.getElementById('liveMarket');
const markerCurrent = document.getElementById('markerCurrent');
const markerPred1 = document.getElementById('markerPred1');
const markerPred2 = document.getElementById('markerPred2');
const digitTable = document.getElementById('digitTable');
const tickCountEl = document.getElementById('tickCount');
const botStateEl = document.getElementById('botState');
const logBox = document.getElementById('logBox');
const cursorDot = document.getElementById('cursorDot');

/* ---------- Utilities ---------- */
function uiLog(msg) {
  const t = new Date().toLocaleTimeString();
  logBox.innerHTML = `<div>[${t}] ${escapeHtml(msg)}</div>` + logBox.innerHTML;
}
function escapeHtml(s){ return String(s).replace(/[&<>"']/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

function renderDigitTable() {
  digitTable.innerHTML = '';
  for(let d=0; d<10; d++){
    const count = digitCounts[d];
    const perc = tickCount? ((count / tickCount) * 100).toFixed(2) : '0.00';
    const highlight = (pred1===d) ? 'highlight' : '';
    digitTable.innerHTML += `<tr class="${highlight}"><td>${d}</td><td>${count}</td><td>${perc}%</td></tr>`;
  }
  tickCountEl.innerText = tickCount;
}

function updateMarkers() {
  markerCurrent.innerText = (lastDigit===null)?'—':lastDigit;
  markerPred1.innerText = (pred1===null)?'—':pred1;
  markerPred2.innerText = (pred2===null)?'—':pred2;

  // Show cursor near the Pred1 element (smooth)
  const rect = markerPred1.getBoundingClientRect();
  if(rect && cursorDot.style){
    cursorDot.style.display = 'block';
    cursorDot.style.transform = `translate(${rect.left + rect.width/2}px, ${rect.top + rect.height/2}px)`;
  }
}

/* ---------- WebSocket ---------- */
function connectWS() {
  disconnectWS(); // ensure clean
  const appId = document.getElementById('appId').value || '1089';
  const url = `wss://ws.binaryws.com/websockets/v3?app_id=${encodeURIComponent(appId)}`;
  ws = new WebSocket(url);

  ws.onopen = () => {
    connectedWS = true;
    statusWsEl.innerText = 'connected';
    wsStateEl.innerText = 'connected';
    uiLog('WebSocket open');
  };

  ws.onclose = (e) => {
    connectedWS = false;
    authorized = false;
    statusWsEl.innerText = 'closed';
    wsStateEl.innerText = 'closed';
    authStateEl.innerText = 'no';
    uiLog('WebSocket closed');
  };

  ws.onerror = (err) => {
    uiLog('WebSocket error: ' + (err?.message || JSON.stringify(err)));
  };

  ws.onmessage = (evt) => {
    try {
      const data = JSON.parse(evt.data);
      if(data.msg_type === 'authorize') {
        if(data.authorize && data.authorize.loginid){
          authorized = true;
          authStateEl.innerText = 'yes';
          uiLog('Authorized: ' + data.authorize.loginid);
        } else {
          authorized = false;
          authStateEl.innerText = 'no';
          uiLog('Authorization failed');
        }
      }

      if(data.msg_type === 'tick' && data.tick) {
        handleTick(data.tick);
      }

      if(data.msg_type === 'buy') {
        uiLog('Buy response: ' + JSON.stringify(data.buy));
      }
      if(data.error) uiLog('Error: ' + JSON.stringify(data.error));
    } catch (e){
      uiLog('WS parse err: ' + e.message);
    }
  };
}

function disconnectWS(){
  if(ws){
    try{ ws.close(); }catch(e){}
    ws = null;
  }
  connectedWS = false;
  authorized = false;
  subscribedMarket = null;
  statusWsEl.innerText = 'closed';
  wsStateEl.innerText = 'closed';
  authStateEl.innerText = 'no';
}

/* ---------- Tick handling / stats ---------- */
function handleTick(tick) {
  const quote = String(tick.quote);
  const last = Number(quote.slice(-1));
  lastDigit = last;
  tickCount++;
  digitCounts[last] = (digitCounts[last] || 0) + 1;

  // simple predictor logic (demo): next digit assumed (last+1)%10
  pred1 = (last + 1) % 10;
  pred2 = (pred1 + 1) % 10;

  renderDigitTable();
  updateMarkers();

  // Auto-trade condition
  if(botRunning){
    const targetRaw = document.getElementById('targetDigit').value;
    const target = (targetRaw === '' || targetRaw === null) ? null : Number(targetRaw);
    // throttle check
    const throttle = Number(document.getElementById('throttle').value) || 0;
    const now = Date.now();
    if(throttle > 0 && now - botLastBuyTs < throttle) {
      // skip due to throttle
      uiLog(`Skipped (throttle) pred ${pred1}`);
      return;
    }

    if(target === null || pred1 === target) {
      // place immediate trade according to autoMode
      const autoMode = document.getElementById('autoMode').value;
      if(autoMode === 'DIGITMATCH') {
        placeBuy({ contract_type:'DIGITMATCH', prediction: pred1 });
      } else if(autoMode === 'CALLPUT') {
        const choice = (pred1 > last) ? 'CALL' : 'PUT';
        placeBuy({ contract_type: choice });
      } else if(autoMode === 'DIGITEVENODD') {
        const isEven = (pred1 % 2) === 0;
        placeBuy({ contract_type: isEven ? 'DIGITEVEN' : 'DIGITODD' });
      } else {
        // fallback
        placeBuy({ contract_type:'DIGITMATCH', prediction: pred1 });
      }
      botLastBuyTs = now;
    } else {
      uiLog(`Skipped — pred ${pred1} != target ${target}`);
    }
  }
}

/* ---------- Subscription & authorize helpers ---------- */
function subscribeTicks(market){
  if(!ws || ws.readyState !== 1) return;
  subscribedMarket = market;
  uiLog('Subscribing ticks: ' + market);
  try {
    ws.send(JSON.stringify({ ticks: market, subscribe: 1 }));
    liveMarketEl.innerText = market;
  } catch(e){
    uiLog('Subscription failed: ' + e.message);
  }
}

function authorizeWithToken(token){
  if(!ws || ws.readyState !== 1) return;
  try {
    ws.send(JSON.stringify({ authorize: token }));
    uiLog('Sent authorize');
  } catch(e){ uiLog('Auth send error: ' + e.message); }
}

/* ---------- Buy request ---------- */
function placeBuy({ contract_type, prediction = null }) {
  if(!ws || ws.readyState !== 1) {
    uiLog('WS not ready for buy');
    return;
  }
  const stake = Number(document.getElementById('stake').value) || 1;
  const dur = Number(document.getElementById('duration').value) || 1;
  const symbol = document.getElementById('market').value;

  const params = {
    amount: stake,
    basis: 'stake',
    contract_type: contract_type,
    currency: 'USD',
    duration: dur,
    duration_unit: 't',
    symbol: symbol
  };

  // if digit-style, attach barrier/prediction
  if(prediction !== null && prediction !== undefined){
    params.barrier = String(prediction);
    params.prediction = String(prediction);
  } else {
    // for over/under or others you can set barriers if needed
    // not setting barrier here for CALL/PUT; Deriv will compute
  }

  const buyReq = { buy: 1, subscribe: 1, price: stake, parameters: params };

  try {
    // Ensure authorized if token present
    const token = document.getElementById('token').value.trim();
    if(token && !authorized) {
      try { ws.send(JSON.stringify({ authorize: token })); } catch {}
    }

    ws.send(JSON.stringify(buyReq));
    uiLog(`Buy sent: ${params.contract_type} ${prediction !== null ? 'pred='+prediction : ''} sym=${symbol} amt=${stake}`);
  } catch(e){
    uiLog('Buy send error: ' + e.message);
  }
}

/* ---------- Manual trade callable from UI ---------- */
function manualTrade(contractType){
  // for digit contracts use pred1 as suggested digit
  if(['DIGITMATCH','DIGITDIFF','DIGITEVEN','DIGITODD','DIGITOVER','DIGITUNDER'].includes(contractType)){
    placeBuy({ contract_type: contractType, prediction: pred1 });
  } else {
    placeBuy({ contract_type: contractType });
  }
}

/* ---------- Bot control ---------- */
document.getElementById('btnStart').addEventListener('click', ()=>{
  const token = document.getElementById('token').value.trim();
  const market = document.getElementById('market').value;
  if(!token) { alert('Please paste your Deriv API token (DEMO recommended)'); return; }

  if(!ws || ws.readyState !== 1){
    connectWS();
    // wait a tiny bit for connection then authorize + subscribe
    const waitMs = 600;
    setTimeout(()=> {
      authorizeWithToken(token);
      subscribeTicks(market);
      startBot();
    }, waitMs);
  } else {
    authorizeWithToken(token);
    subscribeTicks(market);
    startBot();
  }
});

document.getElementById('btnStop').addEventListener('click', ()=> {
  stopBot();
});

/* ---------- Bot Start/Stop funcs ---------- */
function startBot(){
  botRunning = true;
  botStateEl.innerText = 'running';
  uiLog('Bot started (speed mode — immediate trades)');
}

function stopBot(){
  botRunning = false;
  botStateEl.innerText = 'stopped';
  uiLog('Bot stopped by user');
  // optionally keep ws open for monitoring; do not auto-close
}

/* ---------- extras ---------- */
function clearLogs(){ logBox.innerHTML=''; uiLog('Logs cleared'); }
function snapshot(){
  uiLog(`Snapshot ticks:${tickCount} last:${lastDigit} pred1:${pred1} pred2:${pred2}`);
}

/* ---------- initialize UI ---------- */
renderDigitTable();
updateMarkers();
uiLog('UI ready — paste demo token and Start Bot when ready.');
</script>
</body>
</html>
